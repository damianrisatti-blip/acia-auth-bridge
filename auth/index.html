<script>
  const SUPABASE_URL = "https://ikkdezixruomnwhgqigy.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlra2Rleml4cnVvbW53aGdxaWd5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwODk5MzQsImV4cCI6MjA3MjY2NTkzNH0.r4VOd-Fy_Roq_yk5OhvnK407lktw6pFzagRyACiW0-M";
  const APP_DEEP_LINK_DONE = "com.acia.app://reset-done";

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const $status = document.getElementById('status');
  const $phase  = document.getElementById('phase');
  const $form   = document.getElementById('pwdForm');
  const $pwd1   = document.getElementById('pwd1');
  const $pwd2   = document.getElementById('pwd2');
  const $btnSet = document.getElementById('btnSet');
  const $done   = document.getElementById('done');
  const $btnApp = document.getElementById('btnOpenApp');
  const $alt    = document.getElementById('altLink');

  function setStatus(msg, isErr=false) {
    $status.textContent = msg;
    $status.className = 'status' + (isErr ? ' err' : '');
  }

  function parseHashParams() {
    const h = window.location.hash.startsWith('#') ? window.location.hash.slice(1) : window.location.hash;
    const u = new URLSearchParams(h);
    return Object.fromEntries(u.entries());
  }

  async function tryAllExchanges() {
    const url = new URL(window.location.href);
    const code       = url.searchParams.get('code');        // PKCE
    const token_hash = url.searchParams.get('token_hash');  // recovery/signup/invite
    const typeParam  = url.searchParams.get('type');        // recovery|signup|magiclink|invite
    const emailParam = url.searchParams.get('email');       // a veces viene

    // 1) PKCE ?code=
    if (code) {
      const { error } = await supabase.auth.exchangeCodeForSession(window.location.href);
      if (!error) return true;
      console.warn('exchangeCodeForSession error:', error);
    }

    // 2) token_hash + type (no siempre trae email, probamos con y sin)
    if (token_hash && typeParam) {
      let ok = false;
      try {
        const r = await supabase.auth.verifyOtp({ type: typeParam, token_hash, email: emailParam || undefined });
        ok = !r.error;
        if (!ok) console.warn('verifyOtp error:', r.error);
      } catch (e) { console.warn('verifyOtp threw:', e); }
      if (ok) return true;
    }

    // 3) Enlaces antiguos con #access_token en el hash (algunos clientes o trackings)
    const hash = parseHashParams();
    if (hash.access_token && hash.refresh_token) {
      try {
        const { error } = await supabase.auth.setSession({
          access_token: hash.access_token,
          refresh_token: hash.refresh_token,
        });
        if (!error) return true;
        console.warn('setSession error:', error);
      } catch (e) { console.warn('setSession threw:', e); }
    }

    return false;
  }

  async function main() {
    try {
      const exchanged = await tryAllExchanges();

      const { data: { session } } = await supabase.auth.getSession();
      if (!exchanged || !session) {
        $phase.textContent = 'Enlace inválido o expirado';
        setStatus('No pudimos validar el enlace. Abrí el link directamente desde el mail en este dispositivo o pedí uno nuevo.', true);
        return;
      }

      const url = new URL(window.location.href);
      const type =
        url.searchParams.get('type') ||
        (window.location.hash.match(/type=([^&]+)/) || [])[1] ||
        'unknown';

      if (['recovery','signup','invite','magiclink','unknown'].includes(type)) {
        $phase.textContent = 'Definir contraseña';
        setStatus('Ingresá tu nueva contraseña y confirmá.');
        $form.style.display = 'grid';

        $form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const a = $pwd1.value.trim(), b = $pwd2.value.trim();
          if (a.length < 8) return setStatus('La contraseña debe tener al menos 8 caracteres.', true);
          if (a !== b)     return setStatus('Las contraseñas no coinciden.', true);

          $btnSet.disabled = true;
          setStatus('Actualizando contraseña…');

          const { error } = await supabase.auth.updateUser({ password: a });
          if (error) {
            setStatus('Error al actualizar: ' + (error.message || 'desconocido'), true);
            $btnSet.disabled = false;
            return;
          }

          $form.style.display = 'none';
          $done.style.display = 'grid';
          $phase.textContent = '¡Contraseña actualizada!';
          setStatus('Podés volver a la app.');
          $btnApp.onclick = () => window.location.href = APP_DEEP_LINK_DONE;
          $alt.href = APP_DEEP_LINK_DONE;
        });
      } else {
        $phase.textContent = 'Sesión confirmada';
        setStatus('Tu sesión fue confirmada correctamente. Ya podés volver a la app.');
        $done.style.display = 'grid';
        $btnApp.onclick = () => window.location.href = APP_DEEP_LINK_DONE;
        $alt.href = APP_DEEP_LINK_DONE;
      }
    } catch (err) {
      console.error(err);
      $phase.textContent = 'Error';
      setStatus('Ocurrió un error procesando el enlace. Pedí uno nuevo e intentá otra vez.', true);
    }
  }

  main();
</script>
