<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>ACIA ‚Äì Autenticaci√≥n</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex,nofollow" />
  <style>
    :root { color-scheme: dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
           margin: 0; background: #0a0f1f; color: #e8eefc; display: grid; place-items: center; min-height: 100dvh; }
    .card { width: min(560px, 92vw); background: #0f1a36; border: 1px solid #173064; border-radius: 16px; padding: 20px 22px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    h1 { font-size: 1.25rem; margin: 0 0 12px; }
    p { margin: 10px 0; line-height: 1.5; color: #c8d4ff; }
    .status { padding: 10px 12px; border-radius: 10px; background: #0c244f; border: 1px solid #153a7a; font-size: .95rem; white-space: pre-wrap; }
    .row { display: grid; gap: 10px; margin-top: 14px; }
    label { font-size: .9rem; color: #b7c7ff; }
    input { width: 100%; padding: 12px 14px; border-radius: 12px; border: 1px solid #284f9a; background: #0b1733; color: #eef3ff; outline: none; }
    button { margin-top: 10px; padding: 12px 14px; border: 0; border-radius: 12px; background: #1f6fff; color: white; font-weight: 600; cursor: pointer; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .ok { background: #0e3d16; border: 1px solid #1f7a31; }
    .err { background: #3d0e11; border: 1px solid #b93845; }
    .footer { margin-top: 16px; font-size: .9rem; color: #9fb2ff; opacity: .85; }
    a { color: #7fb4ff; text-decoration: underline; }
    .muted { opacity:.8; font-size:.85rem }
  </style>

  <!-- Mostrar errores JS en pantalla para facilitar debug -->
  <script>
    window.onerror = function (msg, src, line, col, err) {
      const el = document.getElementById('status');
      if (el) {
        el.textContent = 'JS error: ' + (err?.stack || msg);
        el.className = 'status err';
        const ph = document.getElementById('phase');
        if (ph) ph.textContent = 'Error de script';
      }
    };
  </script>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"
          defer onload="window.__SUPA_OK__=true"
          onerror="window.__SUPA_OK__=false"></script>
</head>
<body>
  <div class="card">
    <h1>ACIA ¬∑ Confirmaci√≥n / Recuperaci√≥n</h1>
    <p id="phase">Cargando p√°gina‚Ä¶</p>
    <div id="status" class="status">Esper√° un momento‚Ä¶</div>
    <div class="muted">URL: <code id="u"></code></div>

    <form id="pwdForm" class="row" style="display:none">
      <label>Nueva contrase√±a</label>
      <input id="pwd1" type="password" minlength="8" autocomplete="new-password" placeholder="********" />
      <label>Repetir contrase√±a</label>
      <input id="pwd2" type="password" minlength="8" autocomplete="new-password" placeholder="********" />
      <button id="btnSet" type="submit">Guardar contrase√±a</button>
    </form>

    <div id="done" class="row" style="display:none">
      <div class="status ok">¬°Listo! Tu contrase√±a fue actualizada.</div>
      <button id="btnOpenApp" type="button">Abrir la app</button>
      <div class="footer">Si el bot√≥n no abre la app, <a id="altLink" href="#">toc√° ac√°</a>.</div>
    </div>

    <div class="footer">Si ten√©s problemas, reintent√° desde el enlace del mail en este mismo dispositivo.</div>
  </div>

  <script>
    // === Config ===
    const SUPABASE_URL = "https://ikkdezixruomnwhgqigy.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlra2Rleml4cnVvbW53aGdxaWd5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwODk5MzQsImV4cCI6MjA3MjY2NTkzNH0.r4VOd-Fy_Roq_yk5OhvnK407lktw6pFzagRyACiW0-M";
    const APP_DEEP_LINK_DONE = "com.acia.app://reset-done"; // opcional

    // === UI refs ===
    const $status = document.getElementById('status');
    const $phase  = document.getElementById('phase');
    const $form   = document.getElementById('pwdForm');
    const $pwd1   = document.getElementById('pwd1');
    const $pwd2   = document.getElementById('pwd2');
    const $btnSet = document.getElementById('btnSet');
    const $done   = document.getElementById('done');
    const $btnApp = document.getElementById('btnOpenApp');
    const $alt    = document.getElementById('altLink');
    const $u      = document.getElementById('u');

    function setStatus(msg, isErr=false) {
      $status.textContent = msg;
      $status.className = 'status' + (isErr ? ' err' : '');
    }
    function parseHashParams() {
      const h = location.hash.startsWith('#') ? location.hash.slice(1) : location.hash;
      const u = new URLSearchParams(h);
      return Object.fromEntries(u.entries());
    }

    // Intenta todas las variantes conocidas de enlace
    async function tryAllExchanges(supabase) {
      const url = new URL(location.href);
      const code       = url.searchParams.get('code');        // PKCE o a veces OTP con otro nombre
      const token_hash = url.searchParams.get('token_hash');  // OTP ‚Äúcl√°sico‚Äù
      const typeParam  = url.searchParams.get('type');        // recovery|signup|magiclink|invite|email_change
      const emailParam = url.searchParams.get('email');

      // 1) PKCE ?code=
      if (code) {
        const { error } = await supabase.auth.exchangeCodeForSession(location.href);
        if (!error) return true; // funcion√≥ como PKCE
        console.warn('exchangeCodeForSession error:', error);

        // üîÅ FALLBACK AMPLIO: ese "code" puede ser OTP de distintos tipos
        const typesToTry = ['recovery','signup','magiclink','invite','email_change'];
        for (const t of typesToTry) {
          try {
            const r = await supabase.auth.verifyOtp({
              type: t,
              token_hash: code,
              email: emailParam || undefined,
            });
            if (!r.error) return true; // funcion√≥ como OTP
            console.warn(`verifyOtp(${t}) failed:`, r.error);
          } catch (e) {
            console.warn(`verifyOtp(${t}) threw:`, e);
          }
        }
      }

      // 2) token_hash + type (OTP ‚Äúnormal‚Äù con ambos params)
      if (token_hash && typeParam) {
        const r = await supabase.auth.verifyOtp({
          type: typeParam,
          token_hash,
          email: emailParam || undefined,
        });
        if (!r.error) return true;
        console.warn('verifyOtp error:', r.error);
      }

      // 3) Tokens en el hash (#access_token, #refresh_token)
      const h = location.hash.startsWith('#') ? location.hash.slice(1) : location.hash;
      const params = new URLSearchParams(h);
      const access_token  = params.get('access_token');
      const refresh_token = params.get('refresh_token');
      if (access_token && refresh_token) {
        const { error } = await supabase.auth.setSession({ access_token, refresh_token });
        if (!error) return true;
        console.warn('setSession error:', error);
      }

      return false;
    }

    async function main() {
      try {
        // Mostrar URL actual para debug
        $u.textContent = location.href;

        if (!window.__SUPA_OK__ || !window.supabase) {
          $phase.textContent = 'Error cargando librer√≠a';
          setStatus('No se pudo cargar @supabase/supabase-js desde CDN.', true);
          return;
        }

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        $phase.textContent = 'Procesando enlace‚Ä¶';
        setStatus('Intercambiando token‚Ä¶');

        const exchanged = await tryAllExchanges(supabase);
        const { data: { session } } = await supabase.auth.getSession();

        if (!exchanged || !session) {
          $phase.textContent = 'Enlace inv√°lido o expirado';
          setStatus('No pudimos validar el enlace. Abr√≠ el link directamente desde el mail en este dispositivo o ped√≠ uno nuevo.', true);
          return;
        }

        const url = new URL(location.href);
        const type = url.searchParams.get('type') ||
                     (location.hash.match(/type=([^&]+)/) || [])[1] ||
                     'unknown';

        if (['recovery','signup','invite','magiclink','unknown'].includes(type)) {
          $phase.textContent = 'Definir contrase√±a';
          setStatus('Ingres√° tu nueva contrase√±a y confirm√°.');
          $form.style.display = 'grid';

          $form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const a = $pwd1.value.trim(), b = $pwd2.value.trim();
            if (a.length < 8) return setStatus('La contrase√±a debe tener al menos 8 caracteres.', true);
            if (a !== b)     return setStatus('Las contrase√±as no coinciden.', true);

            $btnSet.disabled = true;
            setStatus('Actualizando contrase√±a‚Ä¶');

            const { error } = await supabase.auth.updateUser({ password: a });
            if (error) {
              setStatus('Error al actualizar: ' + (error.message || 'desconocido'), true);
              $btnSet.disabled = false;
              return;
            }

            $form.style.display = 'none';
            $done.style.display = 'grid';
            $phase.textContent = '¬°Contrase√±a actualizada!';
            setStatus('Pod√©s volver a la app.');
            $btnApp.onclick = () => location.href = APP_DEEP_LINK_DONE;
            $alt.href = APP_DEEP_LINK_DONE;
          });
        } else {
          $phase.textContent = 'Sesi√≥n confirmada';
          setStatus('Tu sesi√≥n fue confirmada correctamente. Ya pod√©s volver a la app.');
          $done.style.display = 'grid';
          $btnApp.onclick = () => location.href = APP_DEEP_LINK_DONE;
          $alt.href = APP_DEEP_LINK_DONE;
        }
      } catch (err) {
        console.error(err);
        $phase.textContent = 'Error';
        setStatus('Ocurri√≥ un error procesando el enlace: ' + (err?.message || String(err)), true);
      }
    }

    document.addEventListener('DOMContentLoaded', main);
  </script>
</body>
</html>
