<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>ACIA – Confirmación / Recuperación</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex,nofollow" />
  <style>
    :root { color-scheme: dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
           margin: 0; background: #0a0f1f; color: #e8eefc; display: grid; place-items: center; min-height: 100dvh; }
    .card { width: min(560px, 92vw); background: #0f1a36; border: 1px solid #173064; border-radius: 16px; padding: 20px 22px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    h1 { font-size: 1.25rem; margin: 0 0 12px; }
    p { margin: 10px 0; line-height: 1.5; color: #c8d4ff; }
    .status { padding: 10px 12px; border-radius: 10px; background: #0c244f; border: 1px solid #153a7a; font-size: .95rem; white-space: pre-wrap; }
    .ok { background: #0e3d16; border: 1px solid #1f7a31; }
    .err { background: #3d0e11; border: 1px solid #b93845; }
    .row { display: grid; gap: 10px; margin-top: 14px; }
    label { font-size:.9rem; color:#b7c7ff; }
    input { width:100%; padding:12px 14px; border-radius:12px; border:1px solid #284f9a; background:#0b1733; color:#eef3ff; }
    button { margin-top:10px; padding:12px 14px; border:0; border-radius:12px; background:#1f6fff; color:white; font-weight:600; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
</head>
<body>
  <div class="card">
    <h1>ACIA · Confirmación / Recuperación</h1>
    <p id="phase">Procesando…</p>
    <div id="status" class="status">Esperá un momento…</div>

    <form id="pwdForm" class="row" style="display:none">
      <label>Nueva contraseña</label>
      <input id="pwd1" type="password" minlength="8" autocomplete="new-password" placeholder="********" />
      <label>Repetir contraseña</label>
      <input id="pwd2" type="password" minlength="8" autocomplete="new-password" placeholder="********" />
      <button id="btnSet" type="submit">Guardar contraseña</button>
    </form>

    <div id="done" class="row" style="display:none">
      <div class="status ok">¡Listo! Operación completada.</div>
      <p>Cerrá esta pantalla y volvé a <b>ACIA</b>.</p>
    </div>
  </div>

  <script type="module">
    // ➜ VERIFICAR: que estos sean del MISMO proyecto que envía los mails
    const SUPABASE_URL = "https://ikkdezixruomnwhgqigy.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlra2Rleml4cnVvbW53aGdxaWd5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwODk5MzQsImV4cCI6MjA3MjY2NTkzNH0.r4VOd-Fy_Roq_yk5OhvnK407lktw6pFzagRyACiW0-M";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const $status = document.getElementById('status');
    const $phase  = document.getElementById('phase');
    const $form   = document.getElementById('pwdForm');
    const $pwd1   = document.getElementById('pwd1');
    const $pwd2   = document.getElementById('pwd2');
    const $btnSet = document.getElementById('btnSet');
    const $done   = document.getElementById('done');

    const setStatus = (msg, err=false) => { $status.textContent = msg; $status.className = 'status' + (err ? ' err' : ''); };
    const getHashParams = () => {
      const h = location.hash.startsWith('#') ? location.hash.slice(1) : location.hash;
      return Object.fromEntries(new URLSearchParams(h).entries());
    };

    async function robustExchange() {
      const url   = new URL(window.location.href);
      const code  = url.searchParams.get('code');          // PKCE
      const typeQ = url.searchParams.get('type') || (location.hash.match(/type=([^&]+)/)?.[1]) || '';
      const email = url.searchParams.get('email') || '';
      const debug = url.searchParams.get('debug') === '1';
      const h     = getHashParams();

      // 1) Enlaces antiguos con #access_token/#refresh_token
      if (h.access_token || h.refresh_token || h.type) {
        const { error } = await supabase.auth.getSessionFromUrl({ storeSession: true });
        if (!error) return { ok: true, type: h.type || typeQ || '' };
        if (debug) setStatus('getSessionFromUrl: ' + (error.message || String(error)), true);
      }

      // 2) PKCE (?code=...)
      if (code) {
        // 2a) ¡Clave! Pasar SOLO el code, no toda la URL.
        {
          const { error } = await supabase.auth.exchangeCodeForSession(code);
          if (!error) return { ok: true, type: typeQ || 'signup' };
          if (debug) setStatus('exchangeCodeForSession(code): ' + (error.message || String(error)), true);
        }
        // 2b) Fallbacks: verifyOtp con token / token_hash (requiere email)
        const kinds = ['signup','recovery','magiclink','invite','email_change'];
        if (email) {
          for (const k of kinds) {
            const r = await supabase.auth.verifyOtp({ type: k, token: code, email });
            if (!r.error) return { ok: true, type: k };
          }
          for (const k of kinds) {
            const r = await supabase.auth.verifyOtp({ type: k, token_hash: code, email });
            if (!r.error) return { ok: true, type: k };
          }
        } else if (debug) {
          setStatus('Falta email= en la URL para intentar verifyOtp como fallback.', true);
        }
      }

      return { ok: false, type: typeQ || '' };
    }

    async function main() {
      try {
        $phase.textContent = 'Validando enlace…';
        setStatus('Intercambiando token con el servidor…');

        const ex = await robustExchange();
        const { data: { session } } = await supabase.auth.getSession();

        if (!ex.ok || !session) {
          const h = getHashParams();
          const debug = new URL(window.location.href).searchParams.get('debug') === '1';
          if (h.error || h.error_description) {
            setStatus(`Error: ${h.error} · ${decodeURIComponent(h.error_description || '')}`, true);
          } else {
            setStatus(debug
              ? 'No se pudo validar. Activá &email= en el enlace o revisá el detalle arriba si aparece.'
              : 'No pudimos validar el enlace. Abrí el link directamente desde el mail en este dispositivo o pedí uno nuevo.',
              true);
          }
          $phase.textContent = 'Enlace inválido o expirado';
          return;
        }

        // Recuperación: pedir nueva contraseña; en signup mostramos OK.
        if (ex.type === 'recovery') {
          $phase.textContent = 'Definir nueva contraseña';
          setStatus('Ingresá tu nueva contraseña y confirmá.');
          $form.style.display = 'grid';

          $form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const a = $pwd1.value.trim(), b = $pwd2.value.trim();
            if (a.length < 8) return setStatus('La contraseña debe tener al menos 8 caracteres.', true);
            if (a !== b)     return setStatus('Las contraseñas no coinciden.', true);

            $btnSet.disabled = true;
            setStatus('Actualizando contraseña…');

            const { error } = await supabase.auth.updateUser({ password: a });
            if (error) {
              setStatus('Error al actualizar: ' + (error.message || 'desconocido'), true);
              $btnSet.disabled = false;
              return;
            }

            $form.style.display = 'none';
            $done.style.display = 'grid';
            $phase.textContent = '¡Contraseña actualizada!';
            setStatus('Listo. Cerrá esta pantalla y volvé a ACIA.');
          });
        } else {
          $phase.textContent = 'Cuenta verificada';
          setStatus('¡Cuenta verificada correctamente!');
          $done.style.display = 'grid';
        }
      } catch (e) {
        const debug = new URL(window.location.href).searchParams.get('debug') === '1';
        $phase.textContent = 'Error';
        setStatus(debug ? ('Detalle: ' + (e?.message || String(e))) :
                          'Ocurrió un error procesando el enlace.', true);
      }
    }

    document.addEventListener('DOMContentLoaded', main);
  </script>
</body>
</html>
